<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CannTech Blog Administration</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .btn-approve { background-color: #27ae60; color: white; }
        .btn-approve:hover { background-color: #229954; }
        .btn-reject { background-color: #c0392b; color: white; }
        .btn-reject:hover { background-color: #a93226; }
        .btn-refresh { background-color: #3498db; color: white; margin-left: auto; }
        .btn-refresh:hover { background-color: #2980b9; }
        .btn-clear { background-color: #95a5a6; color: white; }
        .btn-clear:hover { background-color: #7f8c8d; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .content-item.hidden { display: none; }
        .preview-section { background-color: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 2px solid #27ae60; }
        .preview-section h2 { margin-top: 0; color: #2c3e50; }
        .preview-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .preview-tab { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: #ecf0f1; color: #2c3e50; font-weight: bold; transition: all 0.3s; }
        .preview-tab.active { background-color: #27ae60; color: white; }
        .preview-tab:hover { background-color: #229954; color: white; }
        .preview-content { display: none; }
        .preview-content.active { display: block; }
        .preview-item { background-color: white; padding: 12px; margin-bottom: 8px; border-radius: 5px; border-left: 4px solid #27ae60; }
        .preview-item h4 { margin: 0 0 5px 0; color: #2c3e50; }
        .preview-item .preview-meta { font-size: 0.85em; color: #666; }
        .preview-item a { color: #27ae60; text-decoration: none; }
        .preview-item a:hover { text-decoration: underline; }
        #content-list { list-style-type: none; padding: 0; }
        .content-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; transition: opacity 0.3s; }
        .content-item.processing { opacity: 0.5; pointer-events: none; }
        .content-details { flex-grow: 1; min-width: 300px; }
        .content-details h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        .content-details a { color: #27ae60; text-decoration: none; }
        .content-details a:hover { text-decoration: underline; }
        .content-meta { font-size: 0.9em; color: #777; }
        .item-actions .btn { font-size: 0.9em; padding: 5px 10px; }
        .item-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
        .priority-control { display: flex; align-items: center; gap: 5px; margin-right: 10px; }
        .priority-label { font-size: 0.9rem; font-weight: 600; color: #666; }
        .priority-dropdown { padding: 5px 8px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 0.9rem; min-width: 110px; cursor: pointer; transition: border-color 0.3s ease; }
        .priority-dropdown:hover { border-color: #27ae60; }
        .priority-dropdown:focus { outline: none; border-color: #27ae60; box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2); }
        .content-tabs { display: flex; margin: 20px 0 10px 0; border-bottom: 2px solid #e0e0e0; }
        .content-tab { background: none; border: none; padding: 12px 20px; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .content-tab:hover { background-color: #f5f5f5; color: #333; }
        .content-tab.active { color: #27ae60; border-bottom-color: #27ae60; background-color: #f9f9f9; }
        .controls { margin-bottom: 20px; display: none; gap: 10px; align-items: center; flex-wrap: wrap; }
        .controls.active { display: flex; }
        #status-message { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; display: none; }
        .status-success { background-color: #eafaf1; color: #1e8449; }
        .status-error { background-color: #fdedec; color: #cb4335; }
        .visibility-indicator { font-size: 0.8em; padding: 4px 8px; border-radius: 12px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .will-appear-latest { background-color: #e3f2fd; color: #1565c0; }
        .will-appear-picks { background-color: #fff3e0; color: #ef6c00; }
        .published-date { color: #666; font-size: 0.85em; margin-top: 3px; }
        .blog-header { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
        .blog-header h1 { color: white; border: none; padding: 0; margin: 0; }
        .blog-header p { margin: 0.5rem 0 0 0; opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container">
        <div class="blog-header">
            <h1>üìù CannTech Blog Administration</h1>
            <p>Manage CannTech Intelligence articles and blog content</p>
        </div>
        
        <!-- Preview Section -->
        <div class="preview-section">
            <h2>üì∞ Intelligence Hub Preview - CannTech Articles</h2>
            <div class="preview-tabs">
                <button id="preview-latest-tab" class="preview-tab active">Latest Intelligence</button>
                <button id="preview-picks-tab" class="preview-tab">Canvrio's Picks</button>
            </div>
            <div id="preview-latest-content" class="preview-content active"></div>
            <div id="preview-picks-content" class="preview-content"></div>
        </div>
        
        <!-- Content Management Tabs -->
        <div class="content-tabs">
            <button id="pending-tab" class="content-tab active">Pending Blog Articles</button>
            <button id="approved-tab" class="content-tab">Published Blog Articles</button>
        </div>
        
        <!-- Pending Content Controls -->
        <div id="pending-controls" class="controls active">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; color: #2c3e50;">
                <input type="checkbox" id="select-all-pending" style="transform: scale(1.2);">
                Select All
            </label>
            <button id="bulk-approve-btn" class="btn btn-approve">Publish Selected</button>
            <button id="bulk-reject-btn" class="btn btn-reject">Archive Selected</button>
            <button id="bulk-reset-priority-btn" class="btn btn-clear">Reset Priority (Normal)</button>
        </div>
        
        <!-- Approved Content Controls -->
        <div id="approved-controls" class="controls">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; color: #2c3e50;">
                <input type="checkbox" id="select-all-approved" style="transform: scale(1.2);">
                Select All
            </label>
            <button id="bulk-unapprove-btn" class="btn btn-reject">Unpublish Selected</button>
            <button id="bulk-reset-priority-approved-btn" class="btn btn-clear">Reset Priority (Normal)</button>
        </div>
        
        <ul id="content-list"></ul>
        <div id="status-message"></div>
    </div>

    <script>
        const API_BASE_URL = '';
        let allContent = [];
        let filteredContent = [];
        let currentMode = 'pending';
        
        // DOM elements
        const contentList = document.getElementById('content-list');
        const statusMessage = document.getElementById('status-message');
        const bulkApproveBtn = document.getElementById('bulk-approve-btn');
        const bulkRejectBtn = document.getElementById('bulk-reject-btn');
        const bulkUnapproveBtn = document.getElementById('bulk-unapprove-btn');
        const previewLatestTab = document.getElementById('preview-latest-tab');
        const previewPicksTab = document.getElementById('preview-picks-tab');
        const pendingTab = document.getElementById('pending-tab');
        const approvedTab = document.getElementById('approved-tab');
        const pendingControls = document.getElementById('pending-controls');
        const approvedControls = document.getElementById('approved-controls');

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize content
            fetchBlogContent();
            loadPreviewContent();
            
            // Bulk action event listeners
            bulkApproveBtn.addEventListener('click', () => handleBulkAction('approve'));
            bulkRejectBtn.addEventListener('click', () => handleBulkAction('reject'));
            bulkUnapproveBtn.addEventListener('click', () => handleBulkUnapprove());
            
            // Reset priority event listeners
            document.getElementById('bulk-reset-priority-btn').addEventListener('click', () => handleBulkResetPriority());
            document.getElementById('bulk-reset-priority-approved-btn').addEventListener('click', () => handleBulkResetPriority());
            
            // Preview tab event listeners
            previewLatestTab.addEventListener('click', () => switchPreviewTab('latest'));
            previewPicksTab.addEventListener('click', () => switchPreviewTab('picks'));
            
            // Content mode tab event listeners
            pendingTab.addEventListener('click', () => switchContentMode('pending'));
            approvedTab.addEventListener('click', () => switchContentMode('approved'));
            
            // Select All functionality
            document.getElementById('select-all-pending').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('#content-list .content-item:not(.hidden) input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
            
            document.getElementById('select-all-approved').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('#content-list .content-item:not(.hidden) input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // Content list event listeners
            contentList.addEventListener('click', (e) => {
                if (e.target.matches('.approve-btn, .reject-btn, .unapprove-btn, .reuse-btn')) {
                    const contentId = parseInt(e.target.dataset.id);
                    const action = e.target.classList.contains('approve-btn') ? 'approve' : 
                                  e.target.classList.contains('unapprove-btn') ? 'unapprove' :
                                  e.target.classList.contains('reuse-btn') ? 'reuse' : 'reject';
                    handleSingleAction(contentId, action, e.target);
                }
            });

            contentList.addEventListener('change', (e) => {
                if (e.target.matches('.priority-dropdown')) {
                    const contentId = parseInt(e.target.dataset.id);
                    const priority = parseInt(e.target.value);
                    setPriority(contentId, priority);
                }
            });
        });

        const fetchBlogContent = async () => {
            try {
                const mode = currentMode === 'pending' ? 'pending' : 'approved';
                const response = await fetch(`${API_BASE_URL}/api/content/${mode}`);
                
                if (!response.ok) throw new Error('Failed to fetch content');
                
                const data = await response.json();
                if (data.success) {
                    // Filter only CannTech Intelligence articles
                    allContent = data.content.filter(item => item.source === 'CannTech Intelligence');
                    filteredContent = [...allContent];
                    renderContent();
                } else {
                    showStatus('Failed to load content. Please refresh the page.', true);
                }
            } catch (error) {
                console.error('Error fetching content:', error);
                showStatus('Failed to load content. Please refresh the page.', true);
            }
        };

        const loadPreviewContent = async () => {
            try {
                const [latestResponse, picksResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/content/latest?limit=20`),
                    fetch(`${API_BASE_URL}/api/content/canvrio-picks?limit=20`)
                ]);
                
                let latestContent = [];
                let picksContent = [];
                
                if (latestResponse.ok) {
                    const latestData = await latestResponse.json();
                    if (latestData.success) {
                        latestContent = latestData.content.filter(item => item.source === 'CannTech Intelligence');
                    }
                }
                
                if (picksResponse.ok) {
                    const picksData = await picksResponse.json();
                    if (picksData.success) {
                        picksContent = picksData.content.filter(item => item.source === 'CannTech Intelligence');
                    }
                }
                
                renderPreviewContent('latest', latestContent);
                renderPreviewContent('picks', picksContent);
            } catch (error) {
                console.error('Error loading preview content:', error);
            }
        };

        const renderPreviewContent = (section, content) => {
            const container = document.getElementById(`preview-${section}-content`);
            if (!content.length) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No CannTech Intelligence articles in this section.</p>';
                return;
            }
            
            container.innerHTML = content.map(item => `
                <div class="preview-item">
                    <h4><a href="${item.url || '#'}" target="_blank">${item.title}</a></h4>
                    <div class="preview-meta">
                        üìÖ ${new Date(item.published_date).toLocaleDateString()} | 
                        üè∑Ô∏è ${item.category || 'General'} | 
                        ‚≠ê Priority: ${getPriorityText(item.priority)}
                    </div>
                </div>
            `).join('');
        };

        const renderContent = () => {
            if (!filteredContent.length) {
                contentList.innerHTML = '<li style="text-align: center; color: #666; font-style: italic; padding: 2rem;">No CannTech Intelligence articles found.</li>';
                return;
            }

            contentList.innerHTML = filteredContent.map(item => `
                <li class="content-item" data-id="${item.id}">
                    <label>
                        <input type="checkbox" class="bulk-checkbox" data-id="${item.id}">
                    </label>
                    <div class="content-details">
                        <h3><a href="${item.url || '#'}" target="_blank">${item.title}</a></h3>
                        <div class="content-meta">
                            üìÖ ${new Date(item.published_date).toLocaleDateString()} | 
                            üè∑Ô∏è ${item.category || 'General'} | 
                            üìä Source: ${item.source}
                        </div>
                        <div class="published-date">Published: ${item.published_date}</div>
                    </div>
                    <div class="item-actions">
                        <div class="priority-control">
                            <span class="priority-label">Priority:</span>
                            <select class="priority-dropdown" data-id="${item.id}">
                                <option value="1" ${item.priority == 1 ? 'selected' : ''}>1 - High</option>
                                <option value="2" ${item.priority == 2 ? 'selected' : ''}>2 - Medium</option>
                                <option value="3" ${item.priority == 3 ? 'selected' : ''}>3 - Normal</option>
                                <option value="4" ${item.priority == 4 ? 'selected' : ''}>4 - Low</option>
                            </select>
                        </div>
                        ${currentMode === 'pending' ? `
                            <button class="btn btn-approve approve-btn" data-id="${item.id}">Publish</button>
                            <button class="btn btn-reject reject-btn" data-id="${item.id}">Archive</button>
                        ` : `
                            <button class="btn btn-reject unapprove-btn" data-id="${item.id}">Unpublish</button>
                            <button class="btn btn-approve reuse-btn" data-id="${item.id}" style="background-color: #f39c12;">üîÑ Reuse</button>
                        `}
                    </div>
                </li>
            `).join('');
        };

        const handleBulkAction = async (action) => {
            const selectedCheckboxes = document.querySelectorAll('.bulk-checkbox:checked');
            const content_ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

            if (content_ids.length === 0) {
                showStatus('Please select articles to perform a bulk action.', true);
                return;
            }

            try {
                const response = await fetch(`/api/content/bulk/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content_ids })
                });
                if (!response.ok) throw new Error(`Failed to bulk ${action}.`);

                const actionText = action === 'approve' ? 'published' : 'archived';
                showStatus(`${content_ids.length} articles have been ${actionText}.`);
                setTimeout(fetchBlogContent, 1000);
                setTimeout(loadPreviewContent, 1200);
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        };

        const handleBulkUnapprove = async () => {
            const selectedCheckboxes = document.querySelectorAll('.bulk-checkbox:checked');
            const content_ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

            if (content_ids.length === 0) {
                showStatus('Please select articles to unpublish.', true);
                return;
            }

            if (!confirm(`Unpublish ${content_ids.length} selected articles?`)) {
                return;
            }

            try {
                for (const contentId of content_ids) {
                    const response = await fetch(`/api/content/${contentId}/unapprove`, {
                        method: 'POST'
                    });
                    if (!response.ok) throw new Error(`Failed to unpublish article ${contentId}`);
                }

                showStatus(`${content_ids.length} articles have been unpublished.`);
                setTimeout(fetchBlogContent, 1000);
                setTimeout(loadPreviewContent, 1200);
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        };

        const handleBulkResetPriority = async () => {
            const selectedCheckboxes = document.querySelectorAll('.bulk-checkbox:checked');
            const content_ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

            if (content_ids.length === 0) {
                showStatus('Please select articles to reset priority.', true);
                return;
            }

            if (!confirm(`Reset priority to Normal (3) for ${content_ids.length} selected articles?`)) {
                return;
            }

            try {
                for (const contentId of content_ids) {
                    const response = await fetch(`/api/content/${contentId}/priority?priority=3`, {
                        method: 'POST'
                    });
                    if (!response.ok) throw new Error(`Failed to reset priority for article ${contentId}`);
                }

                showStatus(`${content_ids.length} articles have been reset to Normal priority.`);
                
                if (currentMode === 'pending') {
                    setTimeout(fetchBlogContent, 1000);
                } else {
                    setTimeout(fetchBlogContent, 1000);
                }
                setTimeout(loadPreviewContent, 1200);
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        };

        const handleSingleAction = async (contentId, action, button) => {
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const endpoint = action === 'unapprove' ? `/api/content/${contentId}/unapprove` : 
                               action === 'reuse' ? `/api/content/${contentId}/reuse` : 
                               `/api/content/${contentId}/${action}`;
                const response = await fetch(endpoint, { method: 'POST' });
                
                if (!response.ok) throw new Error(`Failed to ${action} content`);
                
                const actionText = action === 'approve' ? 'published' : 
                                  action === 'unapprove' ? 'unpublished' : 
                                  action === 'reuse' ? 'moved to pending for reuse' : 'archived';
                showStatus(`Article ${actionText} successfully.`);
                
                setTimeout(fetchBlogContent, 1000);
                setTimeout(loadPreviewContent, 1200);
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
                button.disabled = false;
                button.textContent = originalText;
            }
        };

        const setPriority = async (contentId, priority) => {
            try {
                const response = await fetch(`/api/content/${contentId}/priority?priority=${priority}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to set priority');
                
                showStatus(`Priority updated to ${getPriorityText(priority)}.`);
                setTimeout(loadPreviewContent, 500);
            } catch (error) {
                console.error(error);
                showStatus('Failed to update priority.', true);
            }
        };

        const switchPreviewTab = (tab) => {
            document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.preview-content').forEach(c => c.classList.remove('active'));
            
            document.getElementById(`preview-${tab}-tab`).classList.add('active');
            document.getElementById(`preview-${tab}-content`).classList.add('active');
        };

        const switchContentMode = (mode) => {
            currentMode = mode;
            
            pendingTab.classList.toggle('active', mode === 'pending');
            approvedTab.classList.toggle('active', mode === 'approved');
            
            pendingControls.classList.toggle('active', mode === 'pending');
            approvedControls.classList.toggle('active', mode === 'approved');
            
            fetchBlogContent();
        };

        const showStatus = (message, isError = false) => {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'status-error' : 'status-success';
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        };

        const getPriorityText = (priority) => {
            const priorities = { 1: 'High', 2: 'Medium', 3: 'Normal', 4: 'Low' };
            return priorities[priority] || 'Normal';
        };
    </script>
</body>
</html>